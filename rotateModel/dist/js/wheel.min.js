$(function () {
    new Vue({
        el: "html",
        data: {
            model: 1,
            backParams: baseJs._getQueryString("back"),
            la: baseJs._getQueryString("la"),
            curday: ((new Date()).getMonth() + 1) + '' + (new Date()).getDate(),
            pi: 0,
            isLoading: !0,
            acid: baseJs._getQueryString("acid"),
            uid: baseJs.getWebGl(),
            ua: baseJs.isWeiXin(),
            i: baseJs._getQueryString("i") || "__IMEI__",
            f: baseJs._getQueryString("f") || "__IDFA__",
            ipaddress: baseJs._getQueryString("ipaddress"),
            times: 8,
            startangel: 0,
            endangel: "",
            award: [],
            awardid: "",
            awardtype: "",
            awardangle: "",
            awardcontent: "",
            awardorderid: "",
            awardimg: "",
            ordernum: "",
            rotateTimer: "",
            timer: "",
            activityDesc: "",
            otherRemark: "",
            idDelay: !1,
            collapse: !1,
            myPrizeLink: "",
            isShowFailedPanel: !1,
            showSuccessPanel: !1,
            isShowRulePanel: !1,
            success: !1,
            isShowAddTips: "",
            showHand: !0,
            isShowAddTipsWifi: "",
            isShowWeiCai: "",
            turnplate: {
                colors: ["#fde804", "#6619be"],
                bRotate: !1
            },
            activityParams: {},
            btnStatus: "",
            color: "",
            color1: "",
            loadingDesc: '努力加载中...'
        },
        methods: {
            _showFailedPanel: function () {
                this.isShowFailedPanel = !1, this._rotateInit()
            },
            _showRulePanel: function () {
                MtaH5.clickStat("rule", {'acid': this.acid+''})
                this.isShowRulePanel = !0
            },
            _hideRulePanel: function () {
                this.isShowRulePanel = !1
            },
            _showMoreProbability: function () {
                this.collapse = !this.collapse
            },
            _showNoTimesPanel: function (t) {
                var i = {
                    name: "more",
                    acid: this.acid,
                    la: this.la,
                    uid: this.uid,
                    model: 'rotateModel',
                    param: this.backParams,
                    turn: t || !1,
                    curday: this.curday,
                };
                new Layer(i)
            },
            _statistics: function () {//首页完成曝光
                var r, s = this;
                try {
                    r = localStorage.getItem("myPrize")
                } catch (e) {
                    r = baseJs.getCookie("myPrize")
                }
                this.myPrize = r ? JSON.parse(r) : {};
                var uid = baseJs.getCookieStorage('webGlV2018');
                if(!uid){
                    baseJs._setuid(s);
                    setTimeout(function () {
                        s._statistics();
                    },50);
                    return;
                }
                this.uid = uid, this._init()
            },
            _init: function () {
                this._rotateInit();
                var i = '/active/getActiveInfo',
                    t = {
                        active_id: this.acid,
                        user_id: this.uid,
                    };
                baseJs._ajax(i, t, "POST", !0, function (e) {
                    if(e.code !== 1) return;
                    this.isLoading = !1, this.times = parseInt(e.data.free_num);
                    var i = {
                        "code": 1,
                        "message": "成功",
                        "data": {
                            "activity": {
                                "otherremark": "",
                                "activityremark": e.data.rule
                            },
                            "award": e.data.ads,
                            "isPopup": false,
                            "marquees": null,
                            "activityparam": {
                                "bodybg": "/dist/rotateModel/img/447ee13f-d615-448b-b5ce-8dfc7fc58db1",
                                "myaward": "/dist/rotateModel/img/6de00c9c-843d-457c-a4b0-5a9b813f78e7",
                                "floatlink": "",
                                "turntable": "/dist/rotateModel/img/b84c44f1-634e-494c-9b77-629b4058809c",
                                "banner": "/dist/rotateModel/img/22650600-6126-4c04-9896-b7b813cfb04d.png",
                                "turntablebg": "/dist/rotateModel/img/dc1564e2-74e4-43cd-87a0-f70ae974f082",
                                "lamp": "/dist/rotateModel/img/4ffd3572-2d38-46c2-8327-dff96ecbc063",
                                "buttonstart": "/dist/rotateModel/img/46f7d8a3-9bca-44bd-8f45-70226265e4e5",
                                "float": "null",
                                "title": e.data.title,
                                "buttonchange": "/dist/rotateModel/img/7a78e024-5245-459e-b5c1-e623979157e4",
                                "fontColor2": "null",
                                "buttonend": "/dist/rotateModel/img/50e2e07d-8706-4f31-861f-1ed433de45e8",
                                "fontColor1": "null",
                                "timebg": "/dist/rotateModel/img/28ab2180-df82-4969-ba20-292883f56f06",
                                "hand": "/dist/rotateModel/img/5e90cb00-6d79-4edc-be7d-9a6eb36cffba"
                            },
                            "business": null
                        },
                        "success": true,
                        "error": false
                    };
                    var pi;
                    try {
                        pi = localStorage.getItem("wheel" + this.acid)
                    } catch (exp) {
                        pi = baseJs.getCookie("wheel" + this.acid)
                    }
                    pi && (pi = JSON.parse(pi));
                    if (pi && pi[this.curday]) {
                        this.pi = pi[this.curday], this.times -= this.pi, this.times < 0 && (this.times = 0)
                    }
					if(this.times == 0 && e.data.free_repeat == '1'){
						this.times = parseInt(e.data.free_num), this.pi = 0, this.myPrize = {};
					}
                    if (1 == +i.code) {
                        this.activityParams = i.data.activityparam, this.award = i.data.award, this.activityDesc = i.data.activity.activityremark, this.otherRemark = i.data.activity.otherremark, document.title = this.activityParams.title, this.btnStatus = this.activityParams.buttonstart;
                        for (var t = 0; t < 6; t++) t % 2 == 0 ? this.color = this.activityParams.fontColor1 : this.color1 = this.activityParams.fontColor2;
                        0 == this.times && (this.btnStatus = this.activityParams.buttonend, this.showHand = !1/*, this._showNoTimesPanel(1)*/)
                    }
                }.bind(this), 'json', function (e) {
                    this.loadingDesc = '网络连接超时，请检查！';
                }.bind(this));
            },
            _rotateInit: function () {
                $(".turnplate").stopRotate(), this.endangel = parseFloat(this.startangel + .1), this.endangel > 300 && (this.startangel = 0, this.endangel = parseFloat(this.startangel + .1)), $(".turnplate").rotate({
                    angle: this.startangel,
                    animateTo: this.endangel,
                    duration: 5,
                    callback: function () {
                        this.startangel = this.endangel
                    }.bind(this)
                }), this.rotateTimer = window.requestAnimationFrame(function () {
                    this._rotateInit()
                }.bind(this))
            },
            _rotate: function () {
                window.cancelAnimationFrame(this.rotateTimer), $(".turnplate").rotate({
                    angle: this.startangel,
                    animateTo: parseFloat(this.startangel) + 1080,
                    duration: 3e3,
                    callback: function () {
                        this.startangel = this.endangel
                    }
                }), this.timer = setTimeout(function () {
                    this._rotate()
                }.bind(this), 200)
            },
            _rotateFn: function (i) {
                clearTimeout(this.timer), $(".turnplate").rotate({
                    angle: this.startangel,
                    animateTo: parseInt(i) + 720,
                    duration: 3e3,
                    callback: function () {//转完了
                        /*console.log("转完了"), */
                        this._exposureActivityTicket(), this.turnplate.bRotate = !1
                    }.bind(this)
                })
            },
            _startWheel: function (i) {
                0 != this.times ? (this.showHand = !1, window.cancelAnimationFrame(this.rotateTimer), this.btnStatus = this.activityParams.buttonchange, setTimeout(function () {
                    this.btnStatus = this.activityParams.buttonstart
                }.bind(this), 100), this.turnplate.bRotate || (this._rotate(), this._joinActivity(), this._showAwards())) : (function () {})() //this._showNoTimesPanel()
            },
            _showAwards: function () {
                this.pi++;
                var pi = {};
                pi[this.curday] = this.pi;
                try {
                    localStorage.setItem("wheel" + this.acid, JSON.stringify(pi))
                } catch (e) {
                    baseJs.setCookie("wheel" + this.acid, JSON.stringify(pi))
                }
                var prize_ids = [];
                for(var o in this.myPrize){
                    prize_ids.push(this.myPrize[o].awardid)
                }
                var i = "/active/lottery",
                    t = {
                        active_id: this.acid,
                        pi: this.pi,
                        user_id: this.uid,
                        prizes: prize_ids.join(','),
                    };
                baseJs._ajax(i, t, "POST", !0, function (i) {
                    if (i.code == 1) {
                        this.link = i.data.url || '', this.account = i.data.account || '', this.success = !0, this.qrcode = i.data.qrcode || '', this.awardid = i.data.id, this.awardtype = i.data.type, this.awardcontent = i.data.name, this.awardimg = i.data.cover_pic, this.awardgo = '立即领取', this.ordernum = null, this.rqy = '/active/receive/?active_id=' + this.acid + '&user_id=' + this.uid + '&prize_id=' + this.awardid, this.awardangle = i.data.degree;
                        //我的奖品
                        var k = this.acid + '#' + this.awardid,
                            prize = {};
                        prize.awardid = this.awardid, prize.img = this.awardimg, prize.title = this.awardcontent, prize.url = this.link, prize.rqy = this.rqy, prize.awardtype = this.awardtype, this.awardtype == '1' && (prize.account = this.account, prize.qrcode = this.qrcode), this.myPrize[k] = prize;
                        MtaH5.clickStat('extracting',{'acid':this.acid+'','awardid':this.awardid+''});
                        try {
                            localStorage.setItem("myPrize", JSON.stringify(this.myPrize))
                        } catch (a) {
                            baseJs.setCookie("myPrize", JSON.stringify(this.myPrize))
                        }
                        var s;
                        switch (this.awardtype){
                            case '1':
                                s = {
                                    id: 6,
                                    cardbgId: 3,
                                    qrcode: this.qrcode,
                                    account: this.account,
                                    title: this.awardcontent,
                                    ticket: this.awardimg,
                                    btntext: this.awardgo,
                                    awardlink: '',
                                    rqy: this.rqy,
                                    model: this.model,
                                };
                                break;
                            case '2':
                                s = {
                                    id: 5,
                                    cardbgId: 3,
                                    title: this.awardcontent,
                                    ticket: this.awardimg,
                                    btntext: this.awardgo,
                                    awardlink: this.link,
                                    rqy: this.rqy,
                                    model: this.model,
                                };
                                break;
                        }
                        s.acid = this.acid, s.awardid = this.awardid, s.uid = this.uid;
                        new Dialog(s, {
                            ele: ".closetc",
                            callback: function () {
                            }.bind(this)
                        })
                        this._rotateFn(this.awardangle)
                    }else{
                        this._rotateFn('360');
                    }
                }.bind(this), 'json', function (e) {
                    this._rotateFn('360');
                }.bind(this))
            },
            _joinActivity: function () {
                this.turnplate.bRotate = !this.turnplate.bRotate
            },
            _exposureActivityTicket: function () {
                this._leavingTimes()
                if (this.success) {
                    $(".popShowPrize").show(), this._rotateInit();
                } else this.isShowFailedPanel = !0
            },
            _leavingTimes: function () {
                this.times--, this.times < 0 && (this.times = 0), 0 == this.times && (this.btnStatus = this.activityParams.buttonend)
            },
            _moreActivity: function () {//更多活动点击

            },
            _myprize: function () {
                var a = this;
                var r = {
                    name: "time",
                    acid: a.acid,
                    uid: a.uid,
                    m: a.model,
                    data: a.myPrize
                };
                new Layer(r)
            },
        },
        watch: {
            award: function () {
                Vue.nextTick(function () {
                })
            }
        },
        ready: function () {
            this.la && baseJs.cnzz(this.la), this._statistics()
        }
    })
});